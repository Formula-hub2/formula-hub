# ----------------------------------------------------------------------------
# Deploy on Webhook Workflow
# This workflow triggers a deployment webhook only after the "Pytest"
# workflow has successfully completed on the main branch.
# ----------------------------------------------------------------------------

name: Deploy on Webhook

on:
  workflow_run:
    # Trigger this workflow only after "Pytest" completes
    workflows: 
      - "Pytest"
    types:
      - completed

jobs:
  deploy:
    # MODIFICADO: Despliega solo si Pytest tuvo éxito Y
    # el evento que disparó Pytest fue un PUSH a TRUNK.
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'trunk'
    runs-on: ubuntu-24.04

    steps:
      # Step: Trigger the external deployment webhook
      - name: Trigger Deployment Webhook
        env:
          WEBHOOK_DOMAIN: ${{ secrets.WEBHOOK_DOMAIN }}
          WEBHOOK_TOKEN: ${{ secrets.WEBHOOK_TOKEN }}
        run: |
          curl -X POST \
            https://${{ secrets.WEBHOOK_DOMAIN }}/webhook/deploy \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_TOKEN }}"
