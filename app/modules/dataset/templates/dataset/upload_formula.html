{% extends "base_template.html" %}

{% block title %}Upload Formula 1 Dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> Formula 1 Data</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">
                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Fakenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Fakenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Fakenodo. Sorry for the inconvenience, Fakenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <form method="POST" action="{{ url_for('dataset.create_dataset', dataset_type='formula') }}" enctype="multipart/form-data">

                <div id="basic_info_form">
                    {{ form.hidden_tag() }}

                    <div class="row">

                        <div class="col-12">
                            <h1 class="h3 mb-3">Basic info</h1>

                            <div class="row" style="padding-left: 2rem">

                                <div class="col-lg-6 col-xs-12 col-md-12">
                                    <div class="mb-3">
                                        {{ form.title.label(class="form-label") }} *
                                        {{ form.title(class="form-control") }}
                                        {% for error in form.title.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="mb-3">
                                        {{ form.desc.label(class="form-label") }} *
                                        {{ form.desc(rows=4, class="form-control") }}
                                        {% for error in form.desc.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-lg-6 col-6">
                                    <div class="mb-3">
                                        {{ form.publication_type.label(class="form-label") }}
                                        {{ form.publication_type(class="form-control") }}
                                    </div>
                                </div>

                                <div class="col-lg-6 col-6">
                                    <div class="mb-3">
                                        {{ form.publication_doi.label(class="form-label") }}
                                        {{ form.publication_doi(class="form-control") }}
                                        {% for error in form.publication_doi.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="mb-3">
                                        {{ form.tags.label(class="form-label") }}
                                        {{ form.tags(class="form-control") }}
                                        {% for error in form.tags.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>

                            <h1 class="h3 mb-3 mt-4">Authors</h1>

                            <div class="row" style="padding-left: 2rem">
                                <div class="col-lg-6 col-12 mb-3">
                                    <label class="form-label">Author name</label>
                                    <input class="form-control" disabled value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                                </div>
                                <div class="col-lg-6 col-12 mb-3">
                                    <label class="form-label">Author affiliation</label>
                                    <input class="form-control" disabled value="{{ current_user.profile.affiliation }}">
                                </div>
                                <div class="col-lg-6 col-12 mb-3">
                                    <label class="form-label">Author ORCID</label>
                                    <input class="form-control" disabled value="{{ current_user.profile.orcid }}">
                                </div>
                            </div>

                            </div>
                    </div>

                    <div class="row">
                        {% if error %}
                            <div class="mt-3 col-lg-6 col-12">
                                <span style="color: red;">{{ error }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Formula 1 Data Upload (.csv)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label" for="csv_file"><strong>Upload CSV File</strong></label>
                            {{ form.csv_file(class="form-control", id="csv_file") }}
                            <div class="form-text">Please upload a valid .csv file containing Formula 1 telemetry or stats.</div>
                            {% for error in form.csv_file.errors %}
                                <span style="color: red;">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <label class="form-check">
                            <input id="agreeCheckbox" class="form-check-input" type="checkbox" required>
                            <span class="form-check-label" style="font-size: 15px">
                                I agree to have my data automatically uploaded to Fakenodo and made available to the public according to the Open Science manifesto.
                            </span>
                        </label>
                        <button type="submit" id="upload_button" class="btn btn-primary mt-3" disabled>
                            <i data-feather="upload" class="center-button-icon"></i>
                            Upload Formula Dataset
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('fakenodo.scripts') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            // L贸gica de habilitaci贸n del bot贸n al marcar el checkbox
            const checkbox = document.getElementById('agreeCheckbox');
            const upload_button = document.getElementById('upload_button');
            const form = document.querySelector('form');

            if (checkbox && upload_button && form) {
                checkbox.addEventListener('change', function () {
                    upload_button.disabled = !checkbox.checked;
                });

                // Asegurarse de que el formulario es multipart (ya que contiene archivos)
                form.setAttribute('enctype', 'multipart/form-data');
            }

            // Llamar a la comprobaci贸n de Fakenodo al cargar
            test_zenodo_connection();
        });
    </script>
{% endblock %}
